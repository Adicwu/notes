## 一 . 提要

在很久很久以前，我使用上古的框架vue3，搭建了一个动漫资源网站，并发表了一篇介绍文章 [由于不好用，就用Vue3+Ts做了个视频网站](https://juejin.cn/post/7109775800915722277)。时日至今他拥有了超过`150`的巨量点赞，让老夫甚是欣慰，然后最近又完成了一个`瀑布流虚拟列表`，于是一个记录知识的念头油然而生

**所以，这篇文章就来讲讲，一些蛇皮的组件实现，当然，是基于vue3和ts**



## 二 . 你可以达成以下成就

- `videojs`调库工程师
- 兼容性不怎么好的`实体拖拽`
- 扩展性不怎么好的`路由级动画过渡`
- 初步实现的``瀑布流虚拟列表``
- 普普通通的`列表curd动画`
- ....其他的想起来再说



## 三 . 那么就，到此为止吧！

### `videojs`调库工程师

> Video.js is a web video player built from the ground up for an HTML5 world. It supports HTML5 video and Media Source Extensions, as well as other playback techs like YouTube and Vimeo (through [plugins](https://videojs.com/plugins/)). It supports video playback on desktops and mobile devices. This project was started mid 2010, and the player is now used on over ~~50,000~~ ~~100,000~~ ~~200,000~~ ~~400,000~~ [700,000 websites](https://trends.builtwith.com/media/VideoJS).（翻译一下就是 用户超多且支持多种格式的播放软件）

#### 1.安装

[videojs官方仓库](https://github.com/videojs/video.js) ，至于文档，一言难尽

```powershell
npm i video.js
npm i @types/video.js -D // 用typescript的再装
```

#### 2.初始化

##### 第一步，我们先简历出模板

```vue
<template>
  <!-- 大坑：由于videojs会在video标签上套一层节点，导致裸video标签时vue无法正常卸载节点 -->
  <div class="video-render">
    <!-- 初始化会用到的video节点（顺便用v-bind做了一下参数透传） -->
    <video ref="videoEl" v-bind="$attrs" />
  </div>
</template>
```

##### 第二步，我们定义结构样式

```vue
<style lang="less" scoped>
.video-render {
  position: relative;
  width: 100%;
  height: 100%;
  & > div,
  video {
    width: 100%;
    height: 100%;
  }
  ::v-deep(.vjs-v7) { // 此处是为了隐藏videojs自己生成的节点(具体他自己有没有提供关闭选项，反正我是没试出来)
    div,
    button {
      display: none !important;
    }
  }
}
</style>
```

##### 第三部，实现播放器的基础功能

首先，初始化`videojs`

```typescript
import videojs, { VideoJsPlayer } from 'video.js'
import {  ref, onMounted } from 'vue'

...
setup(){
	const videoInstance = ref<VideoJsPlayer | null>(null) // 定义一个组件内的全局实例，用于调用videojs的接口
    const videoEl = ref<HTMLVideoElement>() // 定义一个video节点ref
	
    /**
     * 视频地址解析为source格式（videojs需要准确的资源type，此方法非权威方法，具体可自己实现）
     * @param url
     */
    const videoUrlToSource = (url: string) => {
      let type = ''
      const lastKey = url.split('.').pop()
      switch (lastKey) {
        case 'm3u8': {
          type = 'application/x-mpegURL'
          break
        }
        case 'zip': {
          type = 'video/mp4'
          break
        }
        default: {
          type = 'video/' + lastKey
        }
      }
      return {
        src: url,
        type
      }
    }
    
    /**
     * 初始化
     * @param el 视频节点
     * @param url 视频地址
     */
    const videoInit = (el: HTMLVideoElement, url: string) => {
      if (!url || !el) return
      try {
        videoInstance.value = videojs(el, {
          autoplay: true,
          preload: 'auto',
          controls: false,
          sources: [videoUrlToSource(url)]
        })
        videoInstance.value.on('error', (e) => {
          console.log(e)
        })
        return videoInstance.value
      } catch (err) {
        console.log(err, 'init')
        return null
      }
    }
    
    onMounted(() => {
      // 确保video节点获取到后进行初始化
      videoInit(videoEl.value!, props.src)
    })
}
...
```

然后，开始愉快的`调库`

```typescript
/** 修改音量 */
const setVolume = (volume: number) =>
  (videoEl.value!.volume = +(volume / 100).toFixed(1))
/** 修改播放倍数 */
const setPlaybackRate = (rate: number) => (videoEl.value!.playbackRate = rate)
/** 修改当前播放进度 */
const setCurrentTime = (currentTime: number) =>
  (videoEl.value!.currentTime = currentTime)
/** 播放 */
const play = () => videoInstance.value?.play()
/** 暂停 */
const pause = () => videoInstance.value?.pause()
```

最后，记得`来也匆匆，去也冲冲`哦

```typescript
import { onBeforeUnmount } from 'vue'

...
setup(){
    /** 销毁(此方法会删除video节点 暂时不用) */
    const destroy = () => videoInstance.value?.dispose()
	onBeforeUnmount(() => {
      destroy()
    })
}
...
```

#### 3.贴一哈项目仓库组件位置

[VideoRender.vue](https://github.com/Adicwu/comic-pc/blob/master/src/components/AwVideo/VideoRender.vue)



------

### 兼容性不怎么好的`实体拖拽`

> 说到拖拽，我们一眼想到 `啊，h5的新功能嘛，drag他就完事了`。谁都有年轻的时候，等你接触到了，才发现，她和你想的，其实差别又亿点大。注意，此功能目前仅支持运行于chrome内核浏览器中，请酌情观赏

#### *.实机演示

#### 1.写起来

不想写了0.....